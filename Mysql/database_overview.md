#DATABASE OVERVIEW

数据库是由多种互相交互的组件构成

#1.核心组件

1. 进程管理器: 很多数据库具有一个妥善管理的进程池/线程池, 为实现纳秒级操作， 一些数据库使用自己的线程而不是操作系统的线程；
2. 网络管理器：网络IO对于数据库来讲是一个重要问题，尤其是分布式数据库，因此一些数据库有自己的网络管理器；
3. 文件管理器： `磁盘IO是数据库的首要瓶颈`，具备一个文件管理器来处理OS文件系统甚至取代OS文件系统是非常重要的;
4. 安全管理器：用于对用户的验证和授权；
5. 客户端管理器：用于管理客户端连接, 检查用户验证信息，检查数据库访问的授权，检查是否有空闲线程（进程），检查数据库负载;

#2.工具
1. 备份管理器：保存可恢复数据；
2. 复原管理器：用于崩溃后重启数据库于一个一致性状态；
3. 监控管理器：用于记录数据库信息和提供监控数据库的工具；
4. administration管理器：用于保存元数据（如表的名称和结构），提供管理数据库、模式、表空间的工具

#3.查询管理器
将查询转换成可以快速执行的代码；
1. 查询解析器：用于检查查询是否合法；
2. 查询重写器：用于预优化查询；
1.`子查询扁平化`，子查询较难优化，重写器会尝试移除子查询；
2.视图合并；
3.`去除不必要的运算符`，若用了DISTINCT, 其实有UNIGUE约束，DISTINCT会被去掉；
4.排除冗余的join连接；
3. 查询优化器：用于优化查询；
`现代数据库都是用基于成本的优化(CBO)来优化查询`, 针对每一个运算设置一个成本，选择成本最低的运算；
数据库优化器计算的是CPU成本，磁盘IO成本和内存需求；`大多数情况下优化的瓶颈在磁盘IO而不是CPU使用`；
4. 查询执行器：编译和执行查询；

#4.数据管理器
1. 事务管理器：用于处理事务；
2. 缓存管理器：数据处理之前置于内存，或者数据写入磁盘之前置于内存；
3. 数据访问管理器：访问磁盘中的数据；

#查询管理器
#查询优化器对多表关联查询的优化
`连接方式的选择：`
1. `循环嵌套连接`（Nested loop join）, 二层循环，O(m*n);
1.查看外关系所有行；
2.查看内关系的所有行来寻找匹配行；
2. `哈希连接`（Hash join）,
1.读取内关系所有元素；
2.在内存建立哈希表；
3.逐条读取外关系的所有元素；
4.用哈希函数计算外关系元素的哈希值，来查找内关系的元素哈希位置；
5.判断是否与外关系匹配
3. `归并连接`
1.内外关系按关键字进行排序；
2.归并：将排序后的内外关系进行归并

`选取哪种连接方式需要考虑：`
1. 空闲内存
2. 两个数据集的大小
3. 是否有索引
4. 结果是否需要排序
5. 关系是否已经排序
6. 连接的类型（等值连接，内连接，外连接）
7. 数据的分布（若数据是倾斜的，如按姓氏进行连接人，但是同姓的数量较多，哈希函数将产生极不均匀的哈希桶）

实际中还可能有order by, group by, union等运算符，因此对于这样复杂的情况优化器可能使用的方法有：`动态规划，贪婪算法，启发式算法`
1. `动态规划`：很多执行计划是非常相似的，可能有相同的子树(A JOIN B), 因此不必每次计算子树的成本，`将重复子树的成本记录下来防止重复计算`；
2. `贪婪算法`： 先处理一条JOIN, 再依据相同的规则计算新的JOIN, 若A JOIN B成本最低，则计算(A JOIN B), 若再JOIN C最低，则计算(A JOIN B)JOIN C(`最近邻居法`);
3. `其他算法`： 贪婪算法属于`启发式算法`，根据一条规则（启发），保存上一步的方法，附加到当前的步骤来进一步搜索解决方法, 例如基因算法；
`查询优化器是数据库的看家本领`

#事务管理器
ACID事务的概念：
A: 原子性，事务中的SQL是一个整体，只能全部执行或者全部不执行，事务崩溃回到事务开始之前；
I: 隔离性：事务AB同时执行，最终的结果与AB的运行顺序无关；
C: 一致性：只有合法的数据才能写入数据库；
D：持久性：事务COMMIT之后数据要保存到数据库中

隔离级别:
RU, RC, RR, S